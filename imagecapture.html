<!DOCTYPE html>
<html>
<link rel="stylesheet" href="w3.css">
<head>
<meta name=viewport content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>getUserMedia() -> ImageCapture demo</title>
</head>

<body>
<div class="w3-container w3-orange"> Open the system camera and grab frame(s) or take (a) picture(s).</div>

<div class="w3-row">
 <div class="w3-light-green w3-container w3-quarter">Video source: </div>
 <select id="videoSource" class="w3-container w3-select w3-half w3-green "></select>
 <!--<input type="button" id="btn1" class="w3-btn-primary w3-teal w3-round w3-container w3-rest"
        onclick="getUserMedia()" value="Open camera" style="display: none;">-->
</div>

<div class="w3-row">
</div>

<div class="w3-row">
  <input type="button" id="btn-caps" class="w3-btn-primary w3-teal w3-round"
         onclick="getCaps()" value="getPhotoCapabilities()">
  <input type="button" id="btn-photo" class="w3-btn-primary w3-teal w3-round"
         onclick="takePhoto()" value="takePhoto()">
  <input type="button" id="btn-frame" class="w3-btn-primary w3-teal w3-round"
         onclick="grabFrame()" value="grabFrame()">
</div>
<br>
<video id="videotag" class="w3-round w3-border w3-card-4" width="240" height="180"
       autoplay=true>

</body>

<script type="text/javascript" src="dimsum.js"></script>
<script>
var videoSelect = document.querySelector('select#videoSource');
videoSelect.onchange = getUserMedia;
videoSelect.onclick = getUserMedia;

var theStream;
var theImageCapturer;
var theGrabbedFrame;
var theTakenPhoto;
var theCapabilities;

document.body.appendChild(document.createElement("br"));
var theZoomSlider = document.createElement("input");
document.body.appendChild(theZoomSlider);
theZoomSlider.id = "theZoomSlider";
theZoomSlider.setAttribute("type", "range");
theZoomSlider.name = "zoom";
theZoomSlider.step = 20;
theZoomSlider.style.visibility = "hidden";
var theZoomSliderValue = document.createElement("output");
document.body.appendChild(theZoomSliderValue);
theZoomSliderValue.id = "theZoomSliderValue";
theZoomSlider.oninput = function() {
  theZoomSliderValue.value = theZoomSlider.value;
  theImageCapturer.setOptions({ zoom : theZoomSlider.value });
}

document.body.appendChild(document.createElement("br"));
var theWidthSlider = document.createElement("input");
document.body.appendChild(theWidthSlider);
theWidthSlider.id = "theWidthSlider";
theWidthSlider.setAttribute("type", "range");
theWidthSlider.name = "width (pixels)";
theWidthSlider.step = 20;
theWidthSlider.style.visibility = "hidden";
var theWidthSliderValue = document.createElement("output");
document.body.appendChild(theWidthSliderValue);
theWidthSliderValue.id = "theWidthSliderValue";
theWidthSlider.oninput = function() {
  theWidthSliderValue.value = theWidthSlider.value;
  theImageCapturer.setOptions({ imageWidth : theWidthSlider.value });
}

var theHeightSlider = document.createElement("input");
document.body.appendChild(theHeightSlider);
theHeightSlider.id = "theHeightSlider";
theHeightSlider.setAttribute("type", "range");
theHeightSlider.name = "height (pixels)";
theHeightSlider.step = 20;
theHeightSlider.style.visibility = "hidden";
var theHeightSliderValue = document.createElement("output");
document.body.appendChild(theHeightSliderValue);
theHeightSliderValue.id = "theHeightSliderValue";
theHeightSlider.oninput = function() {
  theHeightSliderValue.value = theHeightSlider.value;
  theImageCapturer.setOptions({ imageHeight : theHeightSlider.value });
}

document.body.appendChild(document.createElement("br"));

function gotStream(stream) {
  if (theStream)
    theStream.getTracks().forEach((track) => { track.stop(); });
  theStream = stream;

  var videoTag = document.getElementById("videotag");
  videoTag.src = URL.createObjectURL(theStream);

  theImageCapturer = new ImageCapture(theStream.getVideoTracks()[0]);
  document.getElementById("btn-frame").disabled = false;
  document.getElementById("btn-photo").disabled = false;
  document.getElementById("btn-caps").disabled = false;

  document.getElementById("btn1").style = "display : visible";
}

function takePhoto() {
  theImageCapturer.takePhoto()
  .then(function(a) {
   console.log(" photo taken " + a);
   theTakenPhoto = a;

   var img = document.createElement("img");
   document.body.appendChild(img);
   img.src = URL.createObjectURL(theTakenPhoto);
   console.log("theTakenPhoto has been painted, (" +
               img.width + "x" + img.height + ")");
  });
}

function getCaps() {
  theImageCapturer.getPhotoCapabilities()
  .then(function(caps) {
   console.log(" capabilities retrieved " + caps);
   theCapabilities = caps;

   theZoomSlider.style.visibility = "visible";
   theZoomSlider.min = theCapabilities.zoom.min;
   theZoomSlider.max = theCapabilities.zoom.max;
   theZoomSlider.value = theCapabilities.zoom.current;
   theZoomSliderValue.value = theZoomSlider.value;

   theWidthSlider.style.visibility = "visible";
   theWidthSlider.min = theCapabilities.imageWidth.min;
   theWidthSlider.max = theCapabilities.imageWidth.max;
   theWidthSlider.value = theCapabilities.imageWidth.current;
   theWidthSliderValue.value = theWidthSlider.value;

   theHeightSlider.style.visibility = "visible";
   theHeightSlider.min = theCapabilities.imageHeight.min;
   theHeightSlider.max = theCapabilities.imageHeight.max;
   theHeightSlider.value = theCapabilities.imageHeight.current;
   theHeightSliderValue.value = theHeightSlider.value;
  });
}

function grabFrame() {
  theImageCapturer.grabFrame()
  .then(function(a) {
    console.log(" frame grabbed " + a);
    theGrabbedFrame = a;

    var canvas = document.createElement("canvas");
    document.body.appendChild(canvas);

    canvas.width  = theGrabbedFrame.width;
    canvas.height = theGrabbedFrame.height;
    canvas.className = "w3-round w3-border w3-card-16";
    var context = canvas.getContext("2d");
    context.drawImage(theGrabbedFrame, 0, 0);
    console.log(" theGrabbedFrame has been painted (maybe)");
  });
}

function refreshSources() {
  navigator.mediaDevices.enumerateDevices()
  .then((devices) => {
    devices.forEach((device) => {
      if (device.kind == 'videoinput') {
        var option = document.createElement('option');
        option.value = device.deviceId;
        option.text = device.label || 'Camera #' + (videoSelect.length + 1);
        console.log("cam [" + option.text + "] with id: " + option.value);
        videoSelect.appendChild(option);
      }
    });
  })
  .catch((err) => {
    console.log(err.name + ": " + err.message);
  });
}
refreshSources();

function getUserMediaFailedCallback(error) {
  console.error('User media request denied with error code ' + error.code);
}
function getUserMedia() {
  var videoSource = videoSelect.value;
  console.log("opening camera with id: " + videoSource);
  var constraints = {
    "audio": false,
    "video": {
      deviceId: videoSource ? {exact: videoSource} : undefined,
      width: { exact: 320 },
      height: { exact : 240 }
    }
  };
  console.log(constraints);
  navigator.webkitGetUserMedia(constraints,
                               gotStream,
                               getUserMediaFailedCallback);
};

</script>
</html>
