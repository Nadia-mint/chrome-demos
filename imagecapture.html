<!DOCTYPE html>
<html>
<link rel="stylesheet" href="w3.css">
<head>
<meta name=viewport content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>getUserMedia() -> ImageCapture demo</title>
</head>

<body>
<div class="w3-container w3-orange"> Open the system camera and grab frame(s) or take (a) picture(s).</div>
</body>

<script type="text/javascript" src="dimsum.js"></script>
<script>

var theStream;
var theImageCapturer;
var theGrabbedFrame;
var theTakenPhoto;
var theCapabilities;

createButton("btn1", "Open camera @ 320x240", makeGetStreamX(320, 240, "btn1", gotStream));
document.body.appendChild(document.createElement("br"));

createButton("btn-capture", "Create ImageCapturer", createImageCapturer);
document.getElementById("btn-capture").disabled = true;
document.body.appendChild(document.createElement("br"));
createButton("btn-frame", "grabFrame()", grabFrame);
document.getElementById("btn-frame").disabled = true;
createButton("btn-photo", "takePhoto()", takePhoto);
document.getElementById("btn-photo").disabled = true;
createButton("btn-caps", "getPhotoCapabilities()", getCaps);
document.getElementById("btn-caps").disabled = true;
document.body.appendChild(document.createElement("br"));

document.body.appendChild(document.createElement("br"));
var theZoomSlider = document.createElement("input");
document.body.appendChild(theZoomSlider);
theZoomSlider.id = "theZoomSlider";
theZoomSlider.setAttribute("type", "range");
theZoomSlider.name = "zoom";
theZoomSlider.style.visibility = "hidden";
var theZoomSliderValue = document.createElement("output");
document.body.appendChild(theZoomSliderValue);
theZoomSliderValue.id = "theZoomSliderValue";
theZoomSlider.onchange = function() {
  theZoomSliderValue.value = theZoomSlider.value;
}
document.body.appendChild(document.createElement("br"));

function createImageCapturer() {
  theImageCapturer = new ImageCapture(theStream.getVideoTracks()[0]);
  document.getElementById("btn-capture").disabled = true;
  document.getElementById("btn-frame").disabled = false;
  document.getElementById("btn-photo").disabled = false;
  document.getElementById("btn-caps").disabled = false;
}

function takePhoto() {
  theImageCapturer.takePhoto()
  .then(function(a) { 
   console.log(" photo taken " + a);
   theTakenPhoto = a;  

   var img = document.createElement("img");
   document.body.appendChild(img);
   img.src = URL.createObjectURL(theTakenPhoto);
   console.log(" theTakenPhoto has been painted (maybe)");
  });
}

function getCaps() {
  theImageCapturer.getPhotoCapabilities()
  .then(function(caps) { 
   console.log(" capabilities retrieved " + caps);
   theCapabilities = caps;

   theZoomSlider.style.visibility = "visible";
   theZoomSlider.min = theCapabilities.zoom.min;
   theZoomSlider.max = theCapabilities.zoom.max;
   theZoomSlider.value = theCapabilities.zoom.current;
   theZoomSliderValue.value = theZoomSlider.value;

  });
}

function grabFrame() {
  theImageCapturer.grabFrame()
  .then(function(a) { 
    console.log(" frame grabbed " + a); 
    theGrabbedFrame = a;

    var canvas = document.createElement("canvas");
    document.body.appendChild(canvas);
 
    canvas.width  = theGrabbedFrame.width;
    canvas.height = theGrabbedFrame.height;
    canvas.className = "w3-round w3-border w3-card-16";
    var context = canvas.getContext("2d");
    context.drawImage(theGrabbedFrame, 0, 0);
    console.log(" theGrabbedFrame has been painted (maybe)");
  });
}

function gotStream(stream) {
  theStream = stream;
  const videoTagId = 'videotag';
  createVideoTag(videoTagId, 240, 180, stream);
  document.getElementById("btn-capture").disabled = false;
}

</script>
</html>
