<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
/* global URL */
/* global MediaRecorder */
/* global Blob */

var recorder;
var numRecordedBytes = 0;

// Idea from: http://codepen.io/anon/pen/gpmPzm?editors=101, stuff received 
// data in |chunks|, then blobify it and plug the result in a <video> 
var chunks = [];
// The alternative is, e.g. [1, 2], using MediaSource where we basically pass 
// recorded chunks one by one into a MediaSource associated to a <video>, but 
// this seems not to be BlobEvent friendly, and instead needs Uint8Arrays.
// [1] http://html5-demos.appspot.com/static/media-source.html
// [2] https://github.com/html5rocks/www.html5rocks.com/blob/master/content/tutorials/streaming/multimedia/en/index.md

function startTheParty() {
  navigator.webkitGetUserMedia({video: true, audio: false},
                               getUserMediaOkCallback,
                               getUserMediaFailedCallback);
}
  
function getUserMediaFailedCallback(error) {
  console.error('User media request denied with error code ' + error.code);
}

function getUserMediaOkCallback(stream) {
  console.log("getUserMedia succeeded");
  document.getElementById("localview").src = URL.createObjectURL(stream);

  try {
    recorder = new MediaRecorder(stream, "video/vp8");
  } catch (e) {
    console.assert(false, 'Exception while creating MediaRecorder: ' + e);
    return;
  }
  console.assert(recorder.state == "inactive");
  recorder.ondataavailable = recorderOnDataAvailable;
  recorder.onstop = recorderOnStop;
  recorder.start(); 
  console.log("Recorder is started");
  console.assert(recorder.state == "recording");
}

function recorderOnDataAvailable(event) {
  if (event)
    console.assert(event.data.size > 0, 'Recorded data size should be > 0');
  console.assert(recorder.state == "recording", "State should be 'recording'");

  console.log(event.type);
  numRecordedBytes += event.data.size;
  var reader = new FileReader();
  reader.onload = function(e) {
    chunks.push(reader.result);
  }; 
  reader.readAsArrayBuffer(event.data);
}

function recorderOnStop() {
  console.log('recorderOnStop fired');
  var blob = new Blob(chunks, { 'type' : 'video/ogv; codecs=opus' });
  document.getElementById("video").src = URL.createObjectURL(blob);
}

function stopStreamsAndPlaybackData() {
  document.getElementById("btn").disabled = true;
  console.log('Stopping record and starting playback');
  recorder.stop();
  document.getElementById("localview").muted = true;
}

function createButton(id, text, onClick) {
  const button = document.createElement("input");
  button.id = id;
  button.type = "button";
  button.value = text;
  button.onclick = onClick;
  document.body.appendChild(button);
}
createButton("btn", "Stop recording and play back", stopStreamsAndPlaybackData);

startTheParty();

</script>
</head>
<body>
  <video width="320" height="240" id="video" autoplay="autoplay" controls="true"></video>
  <video width="80" height="60" id="localview" autoplay="autoplay"></video>
  </br>
</body>
</html>
