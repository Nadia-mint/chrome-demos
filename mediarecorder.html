<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
/* global webkitURL */
/* global MediaRecorder */
/* global MediaSource */

var recorder;
var numRecordedBytes = 0;

console.assert(!!(window.MediaSource || window.WebKitMediaSource));
var ms = new MediaSource();
var sourceBuffer;

function startTheParty() {

  var video = document.querySelector('video');
  video.src = window.URL.createObjectURL(ms);

  ms.addEventListener('sourceopen', function(e) {
    sourceBuffer = ms.addSourceBuffer('video/webm; codecs="vorbis,vp8"');
    navigator.webkitGetUserMedia({video: true, audio: false},
                                 getUserMediaOkCallback,
                                 getUserMediaFailedCallback);
  }, false);  
}
  
function getUserMediaFailedCallback(error) {
  console.error('User media request denied with error code ' + error.code);
}

function recorderOnDataAvailable(event) {
  console.assert(event.data.size > 0, 'Recorded data size should be > 0');
  console.assert(recorder.state == "recording", "State should be 'recording'");

  numRecordedBytes += event.data.size;
  console.log("got " + numRecordedBytes + "B of data so far");
  sourceBuffer.append(new Uint8Array(event.data));
}

function recorderOnStop() {
  console.error('Recording stopped.');
}

function getUserMediaOkCallback(stream) {
  console.log("getUserMedia succeeded");
  document.getElementById("localview").src = webkitURL.createObjectURL(stream);

  try {
    recorder = new MediaRecorder(stream, "video/vp8");
  } catch (e) {
    console.assert(false, 'Exception while creating MediaRecorder: ' + e);
  }
  console.assert(recorder.state == "inactive");
  recorder.ondataavailable = recorderOnDataAvailable;
  recorder.onstop = recorderOnStop;
  recorder.start(); 
  console.log("Recorder is started");
  console.assert(recorder.state == "recording");
}

startTheParty();

</script>
</head>
<body>
  <video width="320" height="240" id="video" autoplay="autoplay"></video>
  <video width="80" height="60" id="localview" autoplay="autoplay"></video>
</body>
</html>
