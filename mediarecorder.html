<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
/* global webkitURL */
/* global MediaRecorder */

var stream
var recorder
var receivedBytes = 0;
  
function requestVideo() {
    navigator.webkitGetUserMedia({video: true, audio: false},
                                 getUserMediaOkCallback,
                                 getUserMediaFailedCallback);
  }
  
function getUserMediaFailedCallback(error) {
  console.error('User media request denied with error code ' + error.code);
}

function recorderOnDataAvailable(event) {
  console.assert(event.data.size > 0, 'Recorded data size should be > 0');
  console.assert(recorder.state == "recording", "State should be 'recording'");

  console.log("got " + receivedBytes + "B of data so far");

  receivedBytes += event.data.size;
  var video = document.getElementById("video");
  video.src = window.URL.createObjectURL(event.data);
}

function recorderOnStop() {
  console.error('Recording stopped.');
}

function getUserMediaOkCallback(stream) {
  console.log("getUserMedia succeeded");
  document.getElementById("view1").src = webkitURL.createObjectURL(stream);

  try {
    recorder = new MediaRecorder(stream, "video/vp8");
  } catch (e) {
    console.assert(false, 'Exception while creating MediaRecorder: ' + e);
  }
  console.assert(recorder.state == "inactive");
  recorder.ondataavailable = recorderOnDataAvailable;
  recorder.onstop = recorderOnStop;
  recorder.start(); 
  console.log("Recorder is started");
  console.assert(recorder.state == "recording");
}

</script>
</head>
<body onload="requestVideo();">
  <video width="320" height="240" id="video" autoplay="autoplay"></video>
</body>
</html>
