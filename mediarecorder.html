<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript">

  var stream
  var recorder

  function requestVideo() {
    navigator.webkitGetUserMedia({video: true, audio: false},
                                 getUserMediaOkCallback,
                                 getUserMediaFailedCallback);
  }
  function getUserMediaFailedCallback(error) {
    console.error('User media request denied with error code ' + error.code);
  }
  function recorderOnDataAvailable(event) {
    console.assert(event.data.size > 0, 'Recorded data size should be > 0');
    console.assert(recorder.state == "recording", "State should be 'recording'");

    // TODO(mcasas): Let the test record for a while.
    // TODO(mcasas): Consider storing the recorded data and playing it back.
    console.log("got " + event.data.size + "B of data");
  }
  function recorderOnStop() {
    console.error('Recording stopped.')
  }
  function getUserMediaOkCallback(s) {
    console.log("getUserMedia succeeded");
    stream = s
    document.getElementById("view1").src = webkitURL.createObjectURL(s);

    try {
      recorder = new MediaRecorder(stream, "video/vp8");
    } catch (e) {
      console.assert(false, 'Exception while creating MediaRecorder: ' + e);
    }
    console.assert(recorder.state == "inactive");
    recorder.ondataavailable = recorderOnDataAvailable;
    recorder.onstop = recorderOnStop;
    recorder.start(); 
    console.log("Recorder is started");
    console.assert(recorder.state == "recording");
  }

  </script>
</head>
<body onload="requestVideo();">
  <video width="640" height="480" id="view1" autoplay="autoplay"></video>
</body>
</html>
